{% extends "layout.html" %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">List of Keys</h1>
    <a href="{{ url_for('keys.generate_key') }}" class="btn btn-primary">Generate New Key</a>
  </div>
  
  <!-- Pagination Controls -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="form-inline">
      <label for="pageSizeSelect" class="mr-2">Show:</label>
      <select id="pageSizeSelect" class="form-control form-control-sm" onchange="changePageSize()">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span class="ml-2" id="pageInfo"></span>
    </div>
    <div>
      <button class="btn btn-sm btn-outline-secondary" onclick="previousPage()" id="prevBtn">← Previous</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()" id="nextBtn">Next →</button>
    </div>
  </div>

  <div class="form-group">
    <input
      type="text"
      id="filterInput"
      class="form-control mb-3"
      onkeyup="filterTable()"
      placeholder="Filter by Name, Type, Size, or Date">
  </div>
    <table id="keyTable" class="table table-striped table-sm" data-testid="keys-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th style="cursor:pointer;" onclick="sortTable(2)">Type <span id="sort-2">⇅</span></th>
        <th>Size/Curve/Algorithm</th>
        <th style="cursor:pointer;" onclick="sortTable(4)">Created At <span id="sort-4">⇅</span></th>
        {% if is_admin %}<th style="cursor:pointer;" onclick="sortTable(5)">User <span id="sort-5">⇅</span></th>{% endif %}
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for key in keys %}
      <tr>
        <td>{{ key.id }}</td>
        <td>{{ key.name }}</td>
        <td>{{ key.key_type }}</td>
        <td>
          {% if key.key_type == "RSA" %}
            {{ key.key_size }} bits
          {% elif key.key_type == "EC" %}
            {{ key.curve_name }}
          {% elif key.key_type == "PQC" %}
            {{ key.pqc_alg }}
          {% else %}
            N/A
          {% endif %}
        </td>
        <td>{{ key.created_at_local.strftime('%Y-%m-%d %H:%M') }}</td>
        {% if is_admin %}
          <td>{{ key.user_obj.username if key.user_obj else 'N/A' }}</td>
        {% endif %}
        <td>
            <a href="{{ url_for('keys.view_key', key_id=key.id) }}" 
               class="btn btn-sm btn-info action-pill" data-testid="btn-view-key">View</a>
            <a href="{{ url_for('keys.download_key', key_id=key.id) }}" 
               class="btn btn-sm btn-success action-pill" data-testid="btn-download-key">Download</a>
            <button type="button" class="btn btn-sm btn-warning action-pill" data-copy-target="key-public-{{ key.id }}">Copy Public</button>
            <button type="button" class="btn btn-sm action-pill" style="background-color: #fd7e14; color: #fff;" data-copy-target="key-private-{{ key.id }}">Copy Private</button>
            <form action="{{ url_for('keys.delete_key', key_id=key.id) }}" 
                  method="post" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-danger action-pill"
                      onclick="return confirm('Are you sure?');" data-testid="btn-delete-key">
                Delete
              </button>
            </form>
            <textarea id="key-public-{{ key.id }}" class="d-none">{{ key.public_key }}</textarea>
            <textarea id="key-private-{{ key.id }}" class="d-none">{{ key.private_key }}</textarea>
       </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>


  <script>
    let sortDirections = {};

    function sortTable(columnIndex) {
      var table = document.getElementById('keyTable');
      var rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
      var isAscending = sortDirections[columnIndex] !== 'asc';
      sortDirections[columnIndex] = isAscending ? 'asc' : 'desc';

      document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '⇅');
      document.getElementById('sort-' + columnIndex).textContent = isAscending ? '↑' : '↓';

      rows.sort(function(a, b) {
        var aText = a.cells[columnIndex].textContent.trim();
        var bText = b.cells[columnIndex].textContent.trim();

        if (columnIndex === 4) {
          var aDate = new Date(aText);
          var bDate = new Date(bText);
          return isAscending ? aDate - bDate : bDate - aDate;
        }

        if (aText < bText) return isAscending ? -1 : 1;
        if (aText > bText) return isAscending ? 1 : -1;
        return 0;
      });

      var tbody = table.getElementsByTagName('tbody')[0];
      rows.forEach(row => tbody.appendChild(row));
    }

    function filterTable() {
      var filterValue = document.getElementById('filterInput').value.toLowerCase();
      var filterInput = document.getElementById('filterInput');
      if (filterValue) {
        filterInput.classList.add('filter-input-active');
      } else {
        filterInput.classList.remove('filter-input-active');
      }
      var table = document.getElementById('keyTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      var allDomRows = Array.from(tbody.querySelectorAll('tr'));
      allRows = allDomRows.filter(function(row) {
        var nameText = row.cells[1].textContent.trim().toLowerCase();
        var typeText = row.cells[2].textContent.trim().toLowerCase();
        var sizeText = row.cells[3].textContent.trim().toLowerCase();
        var dateText = row.cells[4].textContent.trim().toLowerCase();
        var userText = '';
        if (row.cells.length > 6) {
          userText = row.cells[5].textContent.trim().toLowerCase();
        }
        return (
          nameText.indexOf(filterValue) > -1 ||
          typeText.indexOf(filterValue) > -1 ||
          sizeText.indexOf(filterValue) > -1 ||
          dateText.indexOf(filterValue) > -1 ||
          userText.indexOf(filterValue) > -1
        );
      });
      // Hide all rows, then show only filtered rows
      allDomRows.forEach(function(row) { row.style.display = 'none'; });
      allRows.forEach(function(row) { row.style.display = ''; });
      showPage(1);
    }

    // Pagination variables
    let currentPage = 1;
    let pageSize = 10;
    let allRows = [];

    function initPagination() {
      var table = document.getElementById('keyTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      allRows = Array.from(tbody.getElementsByTagName('tr'));
      showPage(1);
    }

    function showPage(page) {
      currentPage = page;
      var start = (page - 1) * pageSize;
      var end = start + pageSize;
      
      allRows.forEach((row, index) => {
        if (index >= start && index < end) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      
      updatePaginationInfo();
    }

    function updatePaginationInfo() {
      var totalPages = Math.ceil(allRows.length / pageSize);
      var start = (currentPage - 1) * pageSize + 1;
      var end = Math.min(currentPage * pageSize, allRows.length);
      
      document.getElementById('pageInfo').textContent = 
        `Showing ${start}-${end} of ${allRows.length}`;
      
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      showPage(1);
    }

    function nextPage() {
      var totalPages = Math.ceil(allRows.length / pageSize);
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    }

    function previousPage() {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    }

    let lastKeyState = null;

    async function pollKeyState() {
      try {
        const res = await fetch('/keys/state', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (lastKeyState && (data.count !== lastKeyState.count || data.max_id !== lastKeyState.max_id)) {
          window.location.reload();
          return;
        }
        lastKeyState = data;
      } catch (err) {
        console.debug('key-state poll failed', err);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      initPagination();
      pollKeyState();
      setInterval(pollKeyState, 7000);
    });
  </script>
{% endblock %}

