{% extends "layout.html" %}
{% block content %}
  <div class="d-flex align-items-center mb-3">
    <div>
      <h1 class="mb-0">Certificate Templates</h1>
    </div>
    <div class="ml-auto">
      <a href="{{ url_for('profiles.new_profile_file') }}" class="btn btn-primary">Generate New Certificate Template</a>
    </div>
  </div>
  {% if profiles %}
  <div class="d-flex align-items-center mb-3">
    <div class="form-inline">
      <label for="pageSizeSelect" class="mr-2">Show:</label>
      <select id="pageSizeSelect" class="form-control form-control-sm mr-2" onchange="changePageSize()">
        <option value="10" selected>10</option>
        <option value="25">25</option>
        <option value="50">50</option>
      </select>
      <span id="pageInfo" class="mr-3"></span>
    </div>
    <div class="flex-grow-1 text-center text-muted small">Tip: click any Template  cell to copy its full content.</div>
    <div>
      <button class="btn btn-sm btn-secondary" onclick="previousPage()" id="prevBtn">&lt;- Previous</button>
      <button class="btn btn-sm btn-secondary" onclick="nextPage()" id="nextBtn">Next -&gt;</button>
    </div>
  </div>
  {% endif %}
  <div class="form-group">
    <input type="text" id="filterInput" class="form-control mb-3" onkeyup="filterTable()" placeholder="Filter by any column">
  </div>
  <div class="table-responsive">
    <table class="table table-striped table-sm" id="profileTable">
      <thead>
        <tr>
          <th style="cursor:pointer;" onclick="sortTable(0)">Name <span id="sort-0">&#8645;</span></th>
          <th style="cursor:pointer;" onclick="sortTable(1)">Uses <span id="sort-1">&#8645;</span></th>
          {% if is_admin %}<th style="cursor:pointer;" onclick="sortTable(2)">User <span id="sort-2">&#8645;</span></th>{% endif %}
          <th style="cursor:pointer;" onclick="sortTable({{ 3 if is_admin else 2 }})">Created (Updated) <span id="sort-{{ 3 if is_admin else 2 }}">&#8645;</span></th>
          <th style="cursor:pointer;" onclick="sortTable({{ 4 if is_admin else 3 }})">Template Source <span id="sort-{{ 4 if is_admin else 3 }}">&#8645;</span></th>
          <th style="cursor:pointer;" onclick="sortTable({{ 5 if is_admin else 4 }})">Template <span id="sort-{{ 5 if is_admin else 4 }}">&#8645;</span></th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% if profiles %}
          {% for profile in profiles %}
          {% set content = profile.list_content or '' %}
          {% set has_ext = ('[ v3_ext ]' in content) or ('[v3_ext]' in content) %}
          {% set has_req = ('[ req ]' in content) or ('[req]' in content) %}
          {% set template_value = profile.template_name or 'manually' %}
          <tr>
            <td>{{ profile.name }}</td>
            <td>
              {% if has_ext %}
                <span class="badge" style="background-color: #ffc107; color: black;">ext</span>
              {% endif %}
              {% if has_req %}
                <span class="badge badge-success">req</span>
              {% endif %}
              {% if not has_ext and not has_req %}
                <span class="badge badge-secondary">?</span>
              {% endif %}
            </td>
            {% if is_admin %}<td>{{ profile.user_obj.username if profile.user_obj else '-' }}</td>{% endif %}
            <td>
              {% set created = profile.created_at_local.strftime('%Y-%m-%d %H:%M') if profile.created_at_local else '' %}
              {% set updated = profile.updated_at_local.strftime('%Y-%m-%d %H:%M') if profile.updated_at_local is defined and profile.updated_at_local else '' %}
              {% if created and updated and created != updated %}
                <div>{{ created }}</div>
                <div class="text-muted" style="font-size: 12px;">({{ updated }})</div>
              {% else %}
                {{ created }}
              {% endif %}
            </td>
            <td style="max-width: 260px; white-space: pre-wrap; font-size: 12px; cursor: pointer;" onclick="copyCellText(this)"><textarea class="d-none" aria-hidden="true">{{ template_value }}</textarea>{{ template_value[:200] }}{% if template_value|length > 200 %}...{% endif %}</td>
            <td style="max-width: 320px; white-space: pre-wrap; font-size: 12px; cursor: pointer;" onclick="copyCellText(this)"><textarea class="d-none" aria-hidden="true">{{ content }}</textarea>{{ content[:200] }}{% if content|length > 200 %}...{% endif %}</td>
            <td class="text-nowrap">
              <a href="{{ url_for('profiles.view_profile', name=profile.name) }}" class="btn btn-sm btn-info">View</a>
              <a href="{{ url_for('profiles.new_profile_file', clone_id=profile.id) }}" class="btn btn-sm btn-primary ml-1">Clone</a>
              <a href="{{ url_for('profiles.edit_profile_file', name=profile.name) }}" class="btn btn-sm btn-secondary ml-1">Edit</a>
              <form action="{{ url_for('profiles.delete_profile', name=profile.name) }}" method="post" style="display:inline;" onsubmit="return confirm('Delete this profile?');">
                <button type="submit" class="btn btn-sm btn-danger ml-1">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr><td colspan="{{ 7 if is_admin else 6 }}" class="text-muted">No profiles available.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
  <a href="{{ url_for('profiles.list_templates') }}" class="btn btn-secondary mt-3">Back to Template List</a>

  <script>
    let allRows = [];
    let masterRows = [];
    let currentPage = 1;
    let pageSize = 10;
    let lastProfileState = null;
    let sortDirections = {};

    function collectRows() {
      const tbody = document.querySelector('#profileTable tbody');
      masterRows = Array.from(tbody.querySelectorAll('tr'));
      allRows = masterRows.slice();
    }

    function copyCellText(cell) {
      if (!navigator.clipboard) return;
      const hidden = cell ? cell.querySelector('textarea') : null;
      const value = hidden ? (hidden.value || '').trimStart() : '';
      navigator.clipboard.writeText(value);
      cell.classList.add('text-success');
      setTimeout(() => { cell.classList.remove('text-success'); }, 1200);
    }

    function showPage(page) {
      currentPage = page;
      const start = (page - 1) * pageSize;
      const end = start + pageSize;
      const tbody = document.querySelector('#profileTable tbody');
      tbody.innerHTML = '';
      allRows.slice(start, end).forEach(row => tbody.appendChild(row));
      updatePaginationInfo();
    }

    function updatePaginationInfo() {
      const totalPages = Math.ceil(allRows.length / pageSize) || 1;
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(currentPage * pageSize, allRows.length);
      const pageInfo = document.getElementById('pageInfo');
      if (pageInfo) {
        pageInfo.textContent = `Showing ${start}-${end} of ${allRows.length}`;
      }
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      if (prevBtn) prevBtn.disabled = currentPage === 1;
      if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value, 10);
      showPage(1);
    }

    function nextPage() {
      const totalPages = Math.ceil(allRows.length / pageSize);
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    }

    function previousPage() {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    }

    function filterTable() {
      const filterValue = document.getElementById('filterInput').value.toLowerCase();
      const filterInput = document.getElementById('filterInput');
      if (filterValue) {
        filterInput.classList.add('filter-input-active');
      } else {
        filterInput.classList.remove('filter-input-active');
      }
      allRows = masterRows.filter(function(row) {
        let text = '';
        for (let i = 0; i < row.cells.length - 1; ++i) {
          text += row.cells[i].textContent.trim().toLowerCase() + ' ';
        }
        return text.indexOf(filterValue) > -1;
      });
      masterRows.forEach(function(row) { row.style.display = 'none'; });
      allRows.forEach(function(row) { row.style.display = ''; });
      showPage(1);
    }

    function sortTable(columnIndex) {
      masterRows.sort(function(a, b) {
        const aText = a.cells[columnIndex].textContent.trim().toLowerCase();
        const bText = b.cells[columnIndex].textContent.trim().toLowerCase();
        if (aText < bText) return -1;
        if (aText > bText) return 1;
        return 0;
      });
      if (sortDirections[columnIndex] === 'asc') {
        masterRows.reverse();
        sortDirections[columnIndex] = 'desc';
      } else {
        sortDirections[columnIndex] = 'asc';
      }
      document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '\u21C5');
      document.getElementById('sort-' + columnIndex).textContent = sortDirections[columnIndex] === 'asc' ? '\u2191' : '\u2193';
      filterTable();
    }

    async function pollProfileState() {
      try {
        const res = await fetch('/profiles/state', { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (lastProfileState && (data.count !== lastProfileState.count || data.max_id !== lastProfileState.max_id)) {
          window.location.reload();
          return;
        }
        lastProfileState = data;
      } catch (err) {
        console.debug('profile-state poll failed', err);
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      collectRows();
      showPage(1);
      pollProfileState();
      setInterval(pollProfileState, 7000);
    });
  </script>
{% endblock %}
