{% extends "layout.html" %}
{% block content %}
  <div class="row mb-4">
    <div class="col">
      <h1 class="mb-3">Pikachu CA (R&D Only)</h1>
    </div>
  </div>


  <div class="row">
    <div class="col-md-8">
      <!-- CSR Submission Section -->
      <h2>Submit a CSR</h2>
      <form method="POST" action="/submit" class="csr-form mb-4">
        <div class="form-group">
          <textarea id="csr_textarea" name="csr" rows="10" class="form-control" placeholder="Paste PEM-encoded CSR here..."></textarea>
        </div>
        <button type="submit" class="btn btn-success">Sign CSR</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('csr_textarea').value = '';">Clear CSR</button>
      </form>

      <!-- Load Pending CSR Section -->
      <div class="mb-4">
        <h4>Load a Pending CSR Request</h4>
        <div class="input-group">
          <select id="csr_select" class="form-control">
            {% for req in csr_requests %}
              <option value="{{ req[2]|e }}">{{ req[1] }} (Created: {{ req[3] }})</option>
            {% endfor %}
          </select>
          <div class="input-group-append">
            <button type="button" class="btn btn-outline-secondary" onclick="loadCSR()">Load CSR into Form</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Section -->
    <div class="col-md-4">
      <h2>X509 Extensions</h2>
      <form id="server_ext_form">
        <div class="form-group">
          <select id="server_ext_select" name="server_ext_select" class="form-control">
            {% for ext in server_ext_options %}
              <option value="{{ ext }}">{{ ext }}</option>
            {% endfor %}
          </select>
        </div>
      </form>
      <pre id="server_ext_content" style="background:#f8f9fa; border:1px solid #ccc; padding:8px; min-height:120px; font-size:12px;">Select a config to view its content.</pre>
      <a href="/server_ext" class="btn btn-primary btn-block mb-3">Manage X509 Extensions</a>

      <h2>Validity Period</h2>
      <form method="POST" action="/update_validity">
        <div class="form-group">
          <input type="text" name="validity_days" id="validity_days" class="form-control" value="{{ validity_days|default('365') }}" placeholder="Enter validity (days)">
        </div>
        <button type="submit" class="btn btn-secondary btn-block">Update Validity</button>
      </form>
    </div>
  </div>




  <script>
    function loadCSR() {
      var select = document.getElementById('csr_select');
      var csrText = select.value;
      document.getElementById('csr_textarea').value = csrText;
    }

    // Show server extension config content on selection
    document.addEventListener('DOMContentLoaded', function() {
      var select = document.getElementById('server_ext_select');
      var content = document.getElementById('server_ext_content');
      function updateContent() {
        var val = select.value;
        if (val === 'None') {
          content.textContent = '[ v3_ext ]\n# No additional extensions';
        } else {
          fetch('/get_server_ext_content?name=' + encodeURIComponent(val))
            .then(r => r.ok ? r.text() : 'Error loading config')
            .then(txt => { content.textContent = txt; });
        }
      }
      select.addEventListener('change', updateContent);
      updateContent();
    });
  </script>
{% endblock %}

