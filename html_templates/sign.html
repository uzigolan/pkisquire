{% extends "layout.html" %}
{% block content %}
  <div class="row mb-4">
    <div class="col">
      <h1 class="mb-3">Pikachu CA (R&D Only)</h1>
    </div>
  </div>


  <div class="row">
    <div class="col-md-8">
      <!-- CSR Submission Section -->
      <h2>Submit a CSR</h2>
      <form method="POST" action="/submit" class="csr-form mb-4">
        <input type="hidden" name="policy_id" id="policy_id_submit" value="{{ selected_policy.id if selected_policy }}">
        <div class="form-group">
          <textarea id="csr_textarea" name="csr" rows="10" class="form-control" placeholder="Paste PEM-encoded CSR here..."></textarea>
        </div>
        <button type="submit" class="btn btn-success">Sign CSR</button>
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('csr_textarea').value = '';">Clear CSR</button>
      </form>

      <!-- Load Pending CSR Section -->
      <div class="mb-4">
        <h4>Load a Pending CSR Request</h4>
        <div class="input-group">
          <select id="csr_select" class="form-control">
            {% for req in csr_requests %}
              <option value="{{ req[2]|e }}">{{ req[1] }} (Created: {{ req[3] }})</option>
            {% endfor %}
          </select>
          <div class="input-group-append">
            <button type="button" class="btn btn-outline-secondary" onclick="loadCSR()">Load CSR into Form</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar Section -->
    <div class="col-md-4">
      <h4>Select Policy</h4>
      <p class="text-muted" style="margin-top:-6px;">Manage policies <a href="/ra_policies">here</a>.</p>
      <form id="server_ext_form">
        <div class="form-group">
          <select id="server_ext_select" name="server_ext_select" class="form-control">
            {% for p in ra_policies %}
              <option value="{{ p.id }}" data-validity="{{ p.validity_period }}">{{ p.name }}{% if p.type == 'user' %} (User){% else %} (System){% endif %}</option>
            {% endfor %}
          </select>
        </div>
      </form>
      <h4 class="mt-3">Extension</h4>
      <pre id="server_ext_content" style="background:#f8f9fa; border:1px solid #ccc; padding:8px; min-height:120px; font-size:12px;">Select a config to view its content.</pre>

      <h4>Validity Period</h4>
      <div class="form-group">
        <input type="text" id="validity_days" class="form-control" value="{{ validity_days|default('365') }}" readonly>
      </div>
    </div>
  </div>




  <script>
    function loadCSR() {
      var select = document.getElementById('csr_select');
      var csrText = select.value;
      document.getElementById('csr_textarea').value = csrText;
    }

    // Show server extension config content on selection
    document.addEventListener('DOMContentLoaded', function() {
      var select = document.getElementById('server_ext_select');
      var content = document.getElementById('server_ext_content');
      var validityInput = document.getElementById('validity_days');
      var policySubmit = document.getElementById('policy_id_submit');
      var policyValidity = document.getElementById('policy_id_validity');
      function updateContent() {
        if (!select || select.options.length === 0) {
          content.textContent = '[ v3_ext ]\n# No policy available';
          if (validityInput) validityInput.value = '{{ validity_days|default("365") }}';
          return;
        }
        var val = select.value;
        if (policySubmit) policySubmit.value = val;
        if (policyValidity) policyValidity.value = val;
        var selectedOption = select.options[select.selectedIndex];
        if (selectedOption && selectedOption.dataset && selectedOption.dataset.validity) {
          validityInput.value = selectedOption.dataset.validity;
        }
        fetch('/get_server_ext_content?policy_id=' + encodeURIComponent(val))
          .then(r => r.ok ? r.text() : 'Error loading config')
          .then(txt => { content.textContent = txt; });
      }
      select.addEventListener('change', updateContent);
      updateContent();
    });
  </script>
{% endblock %}

