{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Challenge Passwords</h2>
  <form method="POST" class="mb-4">
    <button type="submit" class="btn btn-primary">Generate New Challenge-Password</button>
  </form>
  {% if generated %}
    <div class="alert alert-success">
      <strong>Generated Challenge-Password:</strong>
      <code>{{ generated.value }}:{{ generated.expires_at|replace(' UTC','Z') }}</code>
      <br>
      <small>Embed this in your CSR as <b>challengePassword</b> (PKCS#9).</small>
    </div>
  {% endif %}
  {% if is_admin and challenge_passwords %}
    <h4>Generated Challenge-Passwords (Session Only)</h4>
    <table class="table table-bordered table-sm">
      <thead>
        <tr>
          <th>Challenge-Password <small style="color: #6c757d;">(click to copy)</small></th>
          <th>Status</th>
          <th>User</th>
          <th>Created At</th>
          <th>Expires At</th>
        </tr>
      </thead>
      <tbody>
        {% for entry in challenge_passwords %}
        <tr>
          <td>
            <code id="cpw-{{ loop.index }}" style="cursor:pointer;" onclick="copyChallengePassword('{{ entry.value }}', {{ loop.index }})">{{ entry.value }}</code>
            <span class="ml-1 text-success" id="cpw-copied-{{ loop.index }}" style="display:none;">Copied!</span>
          </td>
          <td>
            {% if entry.consumed %}
              <span class="badge badge-danger">Consumed</span>
            {% else %}
              <span class="badge badge-success">Available</span>
            {% endif %}
          </td>
          <td>{{ entry.user }}</td>
          <td>{{ entry.created_at }}</td>
          <td>{{ entry.expires_at }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="text-muted">List is cleared on server restart.</div>
    <script>
    function copyChallengePassword(value, idx) {
      navigator.clipboard.writeText(value).then(function() {
        var copied = document.getElementById('cpw-copied-' + idx);
        if (copied) {
          copied.style.display = 'inline';
          setTimeout(function() { copied.style.display = 'none'; }, 1200);
        }
      });
    }

    // Poll for challenge password updates every 5 seconds
    function updateChallengePasswordsTable() {
      fetch('/challenge_passwords/data')
        .then(response => response.json())
        .then(data => {
          var tbody = document.querySelector('table.table tbody');
          if (!tbody) return;
          tbody.innerHTML = '';
          data.forEach(function(entry, idx) {
            var status = entry.consumed
              ? '<span class="badge badge-danger">Consumed</span>'
              : '<span class="badge badge-success">Available</span>';
            var row = `<tr>
              <td><code id="cpw-${idx+1}" style="cursor:pointer;" onclick="copyChallengePassword('${entry.value}', ${idx+1})">${entry.value}</code>
                <span class="ml-1 text-success" id="cpw-copied-${idx+1}" style="display:none;">Copied!</span></td>
              <td>${status}</td>
              <td>${entry.user}</td>
              <td>${entry.created_at}</td>
              <td>${entry.expires_at}</td>
            </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        });
    }
    setInterval(updateChallengePasswordsTable, 5000);
    </script>
  {% endif %}
</div>
{% endblock %}
