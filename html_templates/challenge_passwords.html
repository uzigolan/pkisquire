{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <h2>Challenge Passwords</h2>
  <form method="POST" class="mb-4">
    <button type="submit" class="btn btn-primary" data-testid="btn-generate-challenge-password">Generate New Challenge-Password</button>
  </form>
  {% if generated %}
    <div class="alert alert-success">
      <strong>Generated Challenge-Password:</strong>
      <code>{{ generated.value }}:{{ generated.expires_at|replace(' UTC','Z') }}</code>
      <br>
      <small>Embed this in your CSR as <b>challengePassword</b> (PKCS#9).</small>
    </div>
  {% endif %}
  {% if challenge_passwords %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="form-inline">
        <label for="pageSizeSelect" class="mr-2">Show:</label>
        <select id="pageSizeSelect" class="form-control form-control-sm mr-2" onchange="changePageSize()">
          <option value="10" selected>10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
        <span id="pageInfo" class="mr-3"></span>
      </div>
      <div>
        <button class="btn btn-sm btn-secondary" onclick="previousPage()" id="prevBtn">← Previous</button>
        <button class="btn btn-sm btn-secondary" onclick="nextPage()" id="nextBtn">Next →</button>
      </div>
    </div>
    <div class="form-group">
      <input type="text" id="filterInput" class="form-control mb-3" onkeyup="filterTable()" placeholder="Filter by Password, User, or Date" data-testid="input-filter-challenge-passwords">
    </div>
    {% if is_admin %}
      <form method="POST" action="{{ url_for('delete_all_expired_challenge_passwords') }}" style="display:inline;">
        <input type="hidden" name="scope" value="own">
        <button type="submit" class="btn btn-warning mb-2"
          onclick="return confirm('Delete all your expired challenge passwords? (admin)');" data-testid="btn-delete-my-expired">
          Delete All My Expired
        </button>
      </form>
      <form method="POST" action="{{ url_for('delete_all_expired_challenge_passwords') }}" style="display:inline;">
        <input type="hidden" name="scope" value="all">
        <button type="submit" class="btn btn-danger mb-2"
          onclick="return confirm('Delete ALL expired challenge passwords for ALL users? This cannot be undone!');" data-testid="btn-delete-all-expired">
          Delete All Expired (System)
        </button>
      </form>
    {% else %}
      <form method="POST" action="{{ url_for('delete_all_expired_challenge_passwords') }}" style="display:inline;">
        <input type="hidden" name="scope" value="own">
        <button type="submit" class="btn btn-danger mb-2"
          onclick="return confirm('Delete all your expired challenge passwords?');" data-testid="btn-delete-my-expired">
          Delete All My Expired
        </button>
      </form>
    {% endif %}
    <table id="cpwTable" class="table table-bordered table-sm" data-testid="challenge-passwords-table">
      <thead>
        <tr>
          <th style="cursor:pointer;" onclick="sortTable(0)">Challenge-Password <small style="color: #6c757d;">(click to copy)</small> <span id="sort-0">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(1)">Status <span id="sort-1">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(2)">User <span id="sort-2">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(3)">Created (local) <span id="sort-3">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(4)">Validity <span id="sort-4">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(5)">Expires (local) <span id="sort-5">⇅</span></th>
          <th style="cursor:pointer;" onclick="sortTable(6)">Actions <span id="sort-6">⇅</span></th>
        </tr>
      </thead>
      <tbody>
        {% for entry in challenge_passwords %}
        <tr>
          <td>
            <code id="cpw-{{ loop.index }}" style="cursor:pointer;" onclick="copyChallengePassword('{{ entry.value }}', {{ loop.index }})">{{ entry.value }}</code>
            <span class="ml-1 text-success" id="cpw-copied-{{ loop.index }}" style="display:none;">Copied!</span>
          </td>
          <td>
            {% if entry.consumed %}
              <span id="cpw-status-{{ loop.index }}" class="badge badge-danger">Consumed</span>
            {% elif entry.expired %}
              <span id="cpw-status-{{ loop.index }}" class="badge badge-secondary">Expired</span>
            {% else %}
              <span id="cpw-status-{{ loop.index }}" class="badge badge-success">Available</span>
            {% endif %}
          </td>
          <td>{{ entry.user }}</td>
          <td>{{ entry.created_at_local or entry.created_at_utc }}</td>
          <td>{{ entry.validity }}</td>
          <td>{{ entry.expires_at_local or entry.expires_at_utc }}</td>
          <td>
            {% if entry.allow_delete %}
              <form method="POST" action="{{ url_for('delete_challenge_password', value=entry.value) }}" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this expired challenge password?');">Delete</button>
              </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- List is now persistent in the database. -->
    <div class="mt-3">
      <div style="margin-bottom: 6px;"><strong>Legend:</strong></div>
      <div style="font-weight: 600;">Status</div>
      <div><span class="badge badge-success">Available</span> Not yet used</div>
      <div><span class="badge badge-danger">Consumed</span> Used for enrollment</div>
      <div><span class="badge badge-secondary">Expired</span> Wasn't used in time</div>
    </div>
    <script>
    let sortDirections = {};
    let currentPage = 1;
    let pageSize = 10;
    let allRows = [];

    function copyChallengePassword(value, idx) {
      navigator.clipboard.writeText(value).then(function() {
        var copied = document.getElementById('cpw-copied-' + idx);
        if (copied) {
          copied.style.display = 'inline';
          setTimeout(function() { copied.style.display = 'none'; }, 1200);
        }
      });
    }

    function rebuildTableFromData(data) {
      var tbody = document.getElementById('cpwTable').getElementsByTagName('tbody')[0];
      tbody.innerHTML = '';
      data.forEach(function(entry, idx) {
        var displayCreated = entry.created_at_local || entry.created_at_utc || '';
        var displayExpires = entry.expires_at_local || entry.expires_at_utc || '';
        var expired = entry.expired || false;
        var allowDelete = entry.allow_delete || false;
        var statusClass = entry.consumed ? 'badge badge-danger' : (expired ? 'badge badge-secondary' : 'badge badge-success');
        var statusText = entry.consumed ? 'Consumed' : (expired ? 'Expired' : 'Available');
        var actionsHtml = '';
        if (allowDelete) {
          actionsHtml = `<form method="POST" action="/delete_challenge_password?value=${encodeURIComponent(entry.value)}" style="display:inline;">
              <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this expired challenge password?');">Delete</button>
            </form>`;
        }
        var tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <code id="cpw-${idx+1}" style="cursor:pointer;" onclick="copyChallengePassword('${entry.value}', ${idx+1})">${entry.value}</code>
            <span class="ml-1 text-success" id="cpw-copied-${idx+1}" style="display:none;">Copied!</span>
          </td>
          <td><span id="cpw-status-${idx+1}" class="${statusClass}">${statusText}</span></td>
          <td>${entry.user || ''}</td>
          <td>${displayCreated}</td>
          <td>${entry.validity || ''}</td>
          <td>${displayExpires}</td>
          <td>${actionsHtml}</td>
        `;
        tbody.appendChild(tr);
      });
      allRows = Array.from(tbody.getElementsByTagName('tr'));
    }

    function refreshChallengePasswords() {
      var currentFilter = document.getElementById('filterInput').value;
      fetch('/challenge_passwords/data')
        .then(response => response.json())
        .then(data => {
          rebuildTableFromData(data);
          if (currentFilter) {
            document.getElementById('filterInput').value = currentFilter;
            filterTable();
          } else {
            filterTable();
          }
        });
    }

    function sortTable(columnIndex) {
      var table = document.getElementById('cpwTable');
      var rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
      var isAscending = sortDirections[columnIndex] !== 'asc';
      sortDirections[columnIndex] = isAscending ? 'asc' : 'desc';

      document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '⇅');
      document.getElementById('sort-' + columnIndex).textContent = isAscending ? '↑' : '↓';

      rows.sort(function(a, b) {
        var aText = a.cells[columnIndex].textContent.trim();
        var bText = b.cells[columnIndex].textContent.trim();
        // Date columns (Created (local), Expires (local))
        if (columnIndex === 3 || columnIndex === 5) {
          var aDate = new Date(aText);
          var bDate = new Date(bText);
          return isAscending ? aDate - bDate : bDate - aDate;
        }
        if (aText < bText) return isAscending ? -1 : 1;
        if (aText > bText) return isAscending ? 1 : -1;
        return 0;
      });

      var tbody = table.getElementsByTagName('tbody')[0];
      rows.forEach(row => tbody.appendChild(row));
      allRows = Array.from(tbody.getElementsByTagName('tr'));
      showPage(1);
    }

    function filterTable() {
      var filterValue = document.getElementById('filterInput').value.toLowerCase();
      var filterInput = document.getElementById('filterInput');
      if (filterValue) {
        filterInput.style.backgroundColor = '#fff3cd';
      } else {
        filterInput.style.backgroundColor = '';
      }
      var table = document.getElementById('cpwTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      var allDomRows = Array.from(tbody.querySelectorAll('tr'));
      allRows = allDomRows.filter(function(row) {
        var pwText = row.cells[0].textContent.trim().toLowerCase();
        var statusText = row.cells[1].textContent.trim().toLowerCase();
        var userText = row.cells[2].textContent.trim().toLowerCase();
        var createdText = row.cells[3].textContent.trim().toLowerCase();
        var expiresText = row.cells[5].textContent.trim().toLowerCase();
        return (
          pwText.indexOf(filterValue) > -1 ||
          statusText.indexOf(filterValue) > -1 ||
          userText.indexOf(filterValue) > -1 ||
          createdText.indexOf(filterValue) > -1 ||
          expiresText.indexOf(filterValue) > -1
        );
      });
      // Hide all rows, then show only filtered rows
      allDomRows.forEach(function(row) { row.style.display = 'none'; });
      allRows.forEach(function(row) { row.style.display = ''; });
      showPage(1);
    }

    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSizeSelect').value);
      showPage(1);
    }

    function showPage(page) {
      currentPage = page;
      var start = (page - 1) * pageSize;
      var end = start + pageSize;
      allRows.forEach((row, index) => {
        if (index >= start && index < end) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
      updatePaginationInfo();
    }

    function updatePaginationInfo() {
      var totalPages = Math.ceil(allRows.length / pageSize);
      var start = (currentPage - 1) * pageSize + 1;
      var end = Math.min(currentPage * pageSize, allRows.length);
      document.getElementById('pageInfo').textContent = `Showing ${start}-${end} of ${allRows.length}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage >= totalPages;
    }

    function nextPage() {
      var totalPages = Math.ceil(allRows.length / pageSize);
      if (currentPage < totalPages) {
        showPage(currentPage + 1);
      }
    }

    function previousPage() {
      if (currentPage > 1) {
        showPage(currentPage - 1);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      var table = document.getElementById('cpwTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      allRows = Array.from(tbody.getElementsByTagName('tr'));
      showPage(1);
      setInterval(refreshChallengePasswords, 5000);
    });
    </script>
  {% endif %}
</div>
{% endblock %}
