{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>API Tokens</h2>
    <a href="{{ url_for('account') }}" class="btn btn-link">‚Üê Back to Account</a>
  </div>

  <div class="card mb-4">
    <div class="card-header">Create Token</div>
    <div class="card-body">
      <form method="POST" class="form-inline">
        <div class="form-group mr-3 mb-2">
          <label for="name" class="mr-2">Name</label>
          <input type="text" class="form-control" id="name" name="name" placeholder="e.g. ci-runner" style="min-width: 220px;">
        </div>
        <div class="form-group mr-3 mb-2">
          <label for="length" class="mr-2">Length</label>
          <input type="number" class="form-control" id="length" name="length" min="24" max="256" value="{{ default_length }}" style="width: 120px;">
          <small class="form-text text-muted">24-256 characters</small>
        </div>
        <div class="form-group mr-3 mb-2">
          <label for="validity" class="mr-2">Validity</label>
          <input type="text" class="form-control" id="validity" name="validity" placeholder="e.g. 30d, 12h (optional)" value="{{ default_validity }}" style="min-width: 180px;">
          <small class="form-text text-muted">Default: {{ default_validity }} (h=hours, d=days, m=months, y=years)</small>
        </div>
        <button type="submit" class="btn btn-primary mb-2">Create API Token</button>
      </form>
      {% if generated_token %}
      <div class="alert alert-success mt-3 mb-0">
        <strong>Copy this token now:</strong>
        <code id="generatedToken">{{ generated_token }}</code>
        <button type="button" class="btn btn-sm btn-outline-secondary ml-2" id="copyTokenBtn">Copy</button>
        {% if generated_expires %}
        <div>Expires: {{ generated_expires }}</div>
        {% endif %}
        <small class="d-block mt-1">This is the only time the token is shown. Store it securely.</small>
      </div>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-header">API Tokens</div>
    <div class="card-body">
      {% if tokens %}
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="form-inline">
          <label for="tokensPageSize" class="mr-2">Show:</label>
          <select id="tokensPageSize" class="form-control form-control-sm mr-2">
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select>
          <span id="tokensPageInfo" class="mr-3"></span>
        </div>
        <div>
          <button class="btn btn-sm btn-secondary" id="tokensPrev">&lt; Previous</button>
          <button class="btn btn-sm btn-secondary" id="tokensNext">Next &gt;</button>
        </div>
      </div>
      <div class="form-group">
        <input type="text" id="tokensFilter" class="form-control mb-3" placeholder="Filter by user, name, hash, status, date">
      </div>
      <table class="table table-bordered table-sm" id="tokensTable">
        <thead>
          <tr>
            <th style="cursor:pointer;" data-col="0">Name</th>
            <th style="cursor:pointer;" data-col="1">Hash</th>
            <th style="cursor:pointer;" data-col="2">Created</th>
            <th style="cursor:pointer;" data-col="3">Expires</th>
            <th style="cursor:pointer;" data-col="4">User</th>
            <th style="cursor:pointer;" data-col="5">Last Used</th>
            <th style="cursor:pointer;" data-col="6">Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for token in tokens %}
          <tr>
            <td>{{ token.name }}</td>
            <td><code class="token-hash" data-value="{{ token.token_hash }}" style="cursor:pointer;" title="Click to copy hash">{{ token.token_hash_short }}</code></td>
            <td class="dt-utc" data-utc="{{ token.created_display }}">{{ token.created_display }}</td>
            <td class="dt-utc" data-utc="{{ token.expires_display }}">{{ token.expires_display }}</td>
            <td>{{ token.username }}</td>
            <td class="dt-utc" data-utc="{{ token.last_used_display }}">{{ token.last_used_display }}</td>
            <td><span class="{{ token.status_class }}">{{ token.status }}</span></td>
            <td>
              <form method="POST" action="{{ url_for('users.delete_api_token', token_id=token.id) }}" style="display:inline;">
                <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this token?');">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="mb-0">No API tokens yet.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
class TableController {
  constructor(prefix) {
    this.table = document.getElementById(prefix + "Table");
    this.filterInput = document.getElementById(prefix + "Filter");
    this.pageSizeSelect = document.getElementById(prefix + "PageSize");
    this.pageInfo = document.getElementById(prefix + "PageInfo");
    this.prevBtn = document.getElementById(prefix + "Prev");
    this.nextBtn = document.getElementById(prefix + "Next");
    this.sortDirections = {};
    this.currentPage = 1;
    this.allRows = [];
    if (this.table) {
      this.allRows = Array.from(this.table.getElementsByTagName("tbody")[0].getElementsByTagName("tr"));
      this.bind();
      this.render();
    }
  }

  bind() {
    if (this.filterInput) {
      this.filterInput.addEventListener("keyup", () => this.render());
    }
    if (this.pageSizeSelect) {
      this.pageSizeSelect.addEventListener("change", () => { this.currentPage = 1; this.render(); });
    }
    if (this.prevBtn) {
      this.prevBtn.addEventListener("click", (e) => { e.preventDefault(); this.prevPage(); });
    }
    if (this.nextBtn) {
      this.nextBtn.addEventListener("click", (e) => { e.preventDefault(); this.nextPage(); });
    }
    const headers = this.table ? this.table.querySelectorAll("th[data-col]") : [];
    headers.forEach((th) => {
      th.addEventListener("click", () => {
        const col = parseInt(th.getAttribute("data-col"), 10);
        this.sortTable(col);
      });
    });
  }

  filteredRows() {
    const term = this.filterInput ? this.filterInput.value.toLowerCase() : "";
    if (!term) return this.allRows;
    return this.allRows.filter(row => row.textContent.toLowerCase().includes(term));
  }

  sortTable(colIdx) {
    const isAsc = this.sortDirections[colIdx] !== "asc";
    this.sortDirections[colIdx] = isAsc ? "asc" : "desc";
    this.allRows.sort((a, b) => {
      const aText = (a.cells[colIdx] ? a.cells[colIdx].textContent : "").trim().toLowerCase();
      const bText = (b.cells[colIdx] ? b.cells[colIdx].textContent : "").trim().toLowerCase();
      if (aText < bText) return isAsc ? -1 : 1;
      if (aText > bText) return isAsc ? 1 : -1;
      return 0;
    });
    this.currentPage = 1;
    this.render();
  }

  render() {
    if (!this.table) return;
    const tbody = this.table.getElementsByTagName("tbody")[0];
    tbody.innerHTML = "";
    const rows = this.filteredRows();
    const pageSize = this.pageSizeSelect ? parseInt(this.pageSizeSelect.value, 10) || 10 : rows.length;
    const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
    if (this.currentPage > totalPages) this.currentPage = totalPages;
    const start = (this.currentPage - 1) * pageSize;
    const end = start + pageSize;
    rows.slice(start, end).forEach(r => tbody.appendChild(r));
    if (this.pageInfo) {
      this.pageInfo.textContent = rows.length ? `Showing ${start + 1}-${Math.min(end, rows.length)} of ${rows.length}` : "No results";
    }
    if (this.prevBtn) this.prevBtn.disabled = this.currentPage <= 1;
    if (this.nextBtn) this.nextBtn.disabled = this.currentPage >= totalPages;
  }

  nextPage() {
    const rows = this.filteredRows();
    const pageSize = this.pageSizeSelect ? parseInt(this.pageSizeSelect.value, 10) || 10 : rows.length;
    const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
    if (this.currentPage < totalPages) {
      this.currentPage += 1;
      this.render();
    }
  }

  prevPage() {
    if (this.currentPage > 1) {
      this.currentPage -= 1;
      this.render();
    }
  }
}

document.addEventListener("DOMContentLoaded", function() {
  window.tokensController = new TableController("tokens");
  const copyBtn = document.getElementById("copyTokenBtn");
  const tokenEl = document.getElementById("generatedToken");
  if (copyBtn && tokenEl) {
    copyBtn.addEventListener("click", function() {
      navigator.clipboard.writeText(tokenEl.textContent.trim()).then(function() {
        copyBtn.textContent = "Copied!";
        setTimeout(() => copyBtn.textContent = "Copy", 1200);
      });
    });
  }
  document.querySelectorAll(".token-hash").forEach(function(el) {
    const shortVal = el.textContent;
    const fullVal = el.getAttribute("data-value") || el.textContent;
    el.addEventListener("click", function() {
      const isShort = el.textContent === shortVal;
      if (isShort) {
        el.textContent = fullVal;
        el.title = "Click to copy hash";
      } else {
        navigator.clipboard.writeText(fullVal.trim()).then(function() {
          el.title = "Copied!";
          setTimeout(() => { el.title = "Click to copy hash"; }, 1200);
        });
        el.textContent = shortVal;
      }
    });
  });

  let lastTokenState = null;
  async function pollTokenState() {
    try {
      const res = await fetch("/users/tokens/state", { cache: "no-store" });
      if (!res.ok) return;
      const data = await res.json();
      if (lastTokenState && (data.count !== lastTokenState.count || data.max_id !== lastTokenState.max_id)) {
        window.location.reload();
        return;
      }
      lastTokenState = data;
    } catch (e) {
      // ignore
    }
  }
  setInterval(pollTokenState, 5000);
  pollTokenState();

  function formatUtcCells() {
    document.querySelectorAll(".dt-utc").forEach(function(el) {
      const raw = (el.getAttribute("data-utc") || "").trim();
      if (!raw) return;
      let parsed = raw;
      if (raw.endsWith(" UTC")) {
        parsed = raw.replace(" UTC", "Z");
      } else if (!raw.endsWith("Z")) {
        parsed = raw + "Z";
      }
      const d = new Date(parsed);
      if (!isNaN(d.getTime())) {
        el.textContent = d.toLocaleString();
      }
    });
  }
  formatUtcCells();
});
</script>
{% endblock %}
