{% extends "layout.html" %}
{% block content %}
<h2>User Events</h2>
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="form-inline">
    <label for="pageSizeSelect" class="mr-2">Show:</label>
    <select id="pageSizeSelect" class="form-control form-control-sm" onchange="changePageSize()">
      <option value="10" selected>10</option>
      <option value="25">25</option>
      <option value="50">50</option>
    </select>
    <span class="ml-2" id="pageInfo"></span>
  </div>
  <div>
    <button class="btn btn-sm btn-outline-secondary" onclick="previousPage()" id="prevBtn">← Previous</button>
    <button class="btn btn-sm btn-outline-secondary" onclick="nextPage()" id="nextBtn">Next →</button>
  </div>
</div>
<div class="form-group">
  <input type="text" id="filterInput" class="form-control mb-3" onkeyup="filterTable()" placeholder="Filter by User, Actor, Type, or Details">
</div>
<table id="eventsTable" class="table table-bordered table-striped">
  <thead>
    <tr>
      <th style="cursor:pointer;" onclick="sortTable(0)">Time <span id="sort-0">⇅</span></th>
      <th style="cursor:pointer;" onclick="sortTable(1)">User <span id="sort-1">⇅</span></th>
      <th style="cursor:pointer;" onclick="sortTable(2)">Actor <span id="sort-2">⇅</span></th>
      <th style="cursor:pointer;" onclick="sortTable(3)">Event Type <span id="sort-3">⇅</span></th>
      <th style="cursor:pointer;" onclick="sortTable(4)">Details <span id="sort-4">⇅</span></th>
    </tr>
  </thead>
  <tbody>
    {% for event in events %}
    <tr>
      <td>{{ event.time.replace('T', ' ')[:16] if event.time }}</td>
      <td>{{ event.user }}</td>
      <td>{{ event.actor }}</td>
      <td>
        {% if event.type == 'add' %}
          <span class="badge badge-success">Add</span>
        {% elif event.type == 'delete' %}
          <span class="badge badge-danger">Delete</span>
        {% elif event.type == 'login' %}
          <span class="badge badge-info">Login</span>
        {% elif event.type == 'logout' %}
          <span class="badge badge-purple" style="background-color:#6f42c1;color:white;">Logout</span>
        {% elif event.type == 'pending' %}
          <span class="badge badge-warning">Pending</span>
        {% elif event.type == 'activated' %}
          <span class="badge badge-info">Activated</span>
        {% elif event.type == 'deactivated' %}
          <span class="badge badge-secondary">Deactivated</span>
        {% elif event.type == 'force_logout' %}
          <span class="badge badge-dark">Force Logout</span>
        {% elif event.type == 'change_password' %}
          <span class="badge badge-primary">Change Password</span>
        {% elif event.type == 'api_token_create' %}
          <span class="badge badge-success">API Token Create</span>
        {% elif event.type == 'api_token_delete' %}
          <span class="badge badge-danger">API Token Delete</span>
        {% else %}
          <span class="badge badge-secondary">{{ event.type }}</span>
        {% endif %}
      </td>
      <td style="white-space:pre-line;">
        {% set excluded = ['username', 'by', 'actor_username'] %}
        {% if event.details %}
          {% for k, v in event.details.items() if k not in excluded %}
            {{ k }}: {{ v }}\n
          {% endfor %}
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<div class="mt-3">
  <script>
  function renderEventRow(event) {
    // event can be dict ({time,user,actor,type,details}) or legacy array
    const timeVal = event.time !== undefined ? event.time : (event[3] || '');
    const userVal = event.user !== undefined ? event.user : (event[5] || '');
    const actorVal = event.actor !== undefined ? event.actor : (event[7] || '');
    const typeVal = event.type !== undefined ? event.type : (event[1] || '');
    const detailsObj = event.details !== undefined ? event.details : (event[4] || {});
    let utcTime = '';
    if (timeVal) {
      const d = new Date(timeVal.endsWith('Z') ? timeVal : timeVal + 'Z');
      utcTime = d.toISOString().replace('T', ' ').slice(0, 16);
    }
    let typeBadge = '';
    if (typeVal === 'add') typeBadge = '<span class="badge badge-success">Add</span>';
    else if (typeVal === 'delete') typeBadge = '<span class="badge badge-danger">Delete</span>';
    else if (typeVal === 'login') typeBadge = '<span class="badge badge-info">Login</span>';
    else if (typeVal === 'logout') typeBadge = '<span class="badge badge-purple" style="background-color:#6f42c1;color:white;">Logout</span>';
    else if (typeVal === 'pending') typeBadge = '<span class="badge badge-warning">Pending</span>';
    else if (typeVal === 'activated') typeBadge = '<span class="badge badge-info">Activated</span>';
    else if (typeVal === 'deactivated') typeBadge = '<span class="badge badge-secondary">Deactivated</span>';
    else if (typeVal === 'force_logout') typeBadge = '<span class="badge badge-dark">Force Logout</span>';
    else if (typeVal === 'change_password') typeBadge = '<span class="badge badge-primary">Change Password</span>';
    else if (typeVal === 'api_token_create') typeBadge = '<span class="badge badge-success">API Token Create</span>';
    else if (typeVal === 'api_token_delete') typeBadge = '<span class="badge badge-danger">API Token Delete</span>';
    else typeBadge = `<span class="badge badge-secondary">${typeVal || ''}</span>`;
    const excluded = ['username', 'by', 'actor_username'];
    let detailsStr = '';
    if (detailsObj && typeof detailsObj === 'object') {
      for (const k in detailsObj) {
        if (!excluded.includes(k)) {
          detailsStr += `${k}: ${detailsObj[k]}\n`;
        }
      }
    }
    return `<tr>
      <td>${utcTime}</td>
      <td>${userVal || ''}</td>
      <td>${actorVal || ''}</td>
      <td>${typeBadge}</td>
      <td style=\"white-space:pre-line;\">${detailsStr}</td>
    </tr>`;
  }

  function fetchAndUpdateUserEvents() {
    fetch('/users/events/api')
      .then(response => response.json())
      .then(data => {
        // Only update if data has changed
        if (window._lastUserEventsJson && JSON.stringify(window._lastUserEventsJson) === JSON.stringify(data.events)) {
          return;
        }
        window._lastUserEventsJson = data.events;
        const tbody = document.getElementById('eventsTable').getElementsByTagName('tbody')[0];
        tbody.innerHTML = data.events.map(renderEventRow).join('');
        // Rebuild allRows and preserve current page
        allRows = Array.from(tbody.getElementsByTagName('tr'));
        showPage(currentPage);
      });
  }
  setInterval(fetchAndUpdateUserEvents, 5000);
  window.addEventListener('DOMContentLoaded', fetchAndUpdateUserEvents);
  let sortDirections = {};
  let currentPage = 1;
  let pageSize = 10;
  let allRows = [];

  function sortTable(columnIndex) {
    var table = document.getElementById('eventsTable');
    var rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
    var isAscending = sortDirections[columnIndex] !== 'asc';
    sortDirections[columnIndex] = isAscending ? 'asc' : 'desc';

    document.querySelectorAll('[id^="sort-"]').forEach(el => el.textContent = '⇅');
    document.getElementById('sort-' + columnIndex).textContent = isAscending ? '↑' : '↓';

    rows.sort(function(a, b) {
      var aText = a.cells[columnIndex].textContent.trim();
      var bText = b.cells[columnIndex].textContent.trim();
      if (columnIndex === 0) {
        var aDate = new Date(aText);
        var bDate = new Date(bText);
        return isAscending ? aDate - bDate : bDate - aDate;
      }
      if (aText < bText) return isAscending ? -1 : 1;
      if (aText > bText) return isAscending ? 1 : -1;
      return 0;
    });
    var tbody = table.getElementsByTagName('tbody')[0];
    rows.forEach(row => tbody.appendChild(row));
    filterTable();
  }

  function filterTable() {
    var filterValue = document.getElementById('filterInput').value.toLowerCase();
    var filterInput = document.getElementById('filterInput');
    if (filterValue) {
      filterInput.classList.add('filter-input-active');
    } else {
      filterInput.classList.remove('filter-input-active');
    }
    var table = document.getElementById('eventsTable');
    var tbody = table.getElementsByTagName('tbody')[0];
    var rows = tbody.getElementsByTagName('tr');
    var prevAllRows = allRows ? allRows.slice() : [];
    allRows = [];
    for (var i = 0; i < rows.length; i++) {
      rows[i].style.display = 'none';
      var timeText = rows[i].cells[0].textContent.trim().toLowerCase();
      var userText = rows[i].cells[1].textContent.trim().toLowerCase();
      var actorText = rows[i].cells[2].textContent.trim().toLowerCase();
      var typeText = rows[i].cells[3].textContent.trim().toLowerCase();
      var detailsText = rows[i].cells[4].textContent.trim().toLowerCase();
      if (timeText.indexOf(filterValue) > -1 ||
          userText.indexOf(filterValue) > -1 ||
          actorText.indexOf(filterValue) > -1 ||
          typeText.indexOf(filterValue) > -1 ||
          detailsText.indexOf(filterValue) > -1) {
        allRows.push(rows[i]);
      }
    }
    // Only reset to page 1 if filter value changed
    if (filterTable.lastValue !== filterValue) {
      filterTable.lastValue = filterValue;
      showPage(1);
    } else {
      showPage(currentPage);
    }
  }

  function showPage(page) {
    currentPage = page;
    var start = (page - 1) * pageSize;
    var end = start + pageSize;
    allRows.forEach((row, index) => {
      if (index >= start && index < end) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
    updatePaginationInfo();
  }

  function updatePaginationInfo() {
    var totalPages = Math.ceil(allRows.length / pageSize);
    var start = (currentPage - 1) * pageSize + 1;
    var end = Math.min(currentPage * pageSize, allRows.length);
    document.getElementById('pageInfo').textContent = `Showing ${start}-${end} of ${allRows.length}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage >= totalPages;
  }

  function changePageSize() {
    pageSize = parseInt(document.getElementById('pageSizeSelect').value);
    filterTable();
  }

  function nextPage() {
    var totalPages = Math.ceil(allRows.length / pageSize);
    if (currentPage < totalPages) {
      showPage(currentPage + 1);
    }
  }

  function previousPage() {
    if (currentPage > 1) {
      showPage(currentPage - 1);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    filterTable();
  });
  </script>
  <div style="margin-bottom: 6px;"><strong>Event Types Legend:</strong></div>
  <div style="display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 12px 32px; max-width: 600px;">
    <div>
      <div><span class="badge badge-success">Add</span> Add User</div>
      <div><span class="badge badge-danger">Delete</span> Delete User</div>
      <div><span class="badge badge-info">Login</span> Login</div>
      <div><span class="badge badge-secondary">Logout</span> Logout</div>
      <div><span class="badge badge-warning">Pending</span> Pending</div>
      <div><span class="badge badge-info">Activated</span> Activated</div>
      <div><span class="badge badge-secondary">Deactivated</span> Deactivated</div>
      <div><span class="badge badge-dark">Force Logout</span> Force Logout</div>
      <div><span class="badge badge-primary">Change Password</span> Change Password</div>
      <div><span class="badge badge-success">API Token Create</span> API token created</div>
      <div><span class="badge badge-danger">API Token Delete</span> API token deleted</div>
    </div>
    <div>
      <div style="font-weight: 600;">Details</div>
      <div>Additional info about the event (IP, reason, etc.)</div>
    </div>
  </div>
</div>
{% endblock %}
