{% extends "layout.html" %}
{% block content %}
  <h1 class="mb-4">{{ 'Edit Enrollment Policy' if mode == 'edit' else 'New Enrollment Policy' }}</h1>
  <form method="POST">
    {% if mode == 'new' %}
    <div class="form-group">
      <label for="name">Enrollment Policy Name</label>
      <input type="text" class="form-control" id="name" name="name" placeholder="my_policy" required>
    </div>
    {% else %}
    <div class="form-group">
      <label>Enrollment Policy Name</label>
      <input type="text" class="form-control" value="{{ policy.name }}" disabled>
    </div>
    {% endif %}

    <div class="form-group">
      <label for="validity">Validity (days)</label>
      <input type="text" class="form-control" id="validity" name="validity" value="{{ policy.validity_period if policy else '365' }}">
    </div>

    {% if is_admin %}
    <div class="form-check mb-3">
      <input class="form-check-input" type="checkbox" id="is_system" name="is_system" {% if policy and policy.type == 'system' %}checked{% endif %} {% if policy and policy.type == 'system' %}{% endif %}>
      <label class="form-check-label" for="is_system">System enrollment policy (visible to all)</label>
    </div>
    <div class="form-check mb-2">
      <input class="form-check-input" type="checkbox" id="is_est_default" name="is_est_default" {% if policy and policy.is_est_default %}checked{% endif %}>
      <label class="form-check-label" for="is_est_default">Use for EST</label>
    </div>
    <div class="form-check mb-4">
      <input class="form-check-input" type="checkbox" id="is_scep_default" name="is_scep_default" {% if policy and policy.is_scep_default %}checked{% endif %}>
      <label class="form-check-label" for="is_scep_default">Use for SCEP</label>
    </div>
    {% endif %}

    <div class="form-group">
      <label for="profile_name">Load extension from certificate template (optional)</label>
      <div class="input-group mb-2">
        <select class="form-control" name="profile_name" id="profile_name">
          <option value="">-- Select certificate template --</option>
          {% for p in profiles %}
            {% if p.content and '[ v3_ext ]' in p.content %}
              <option value="{{ p.name }}">{{ p.name }}</option>
            {% endif %}
          {% endfor %}
        </select>
        <div class="input-group-append">
          <button class="btn btn-outline-secondary" type="button" id="load_profile_btn">Load into form</button>
        </div>
      </div>
      <label for="ext_config" class="font-weight-bold">Extension configuration</label>
      <textarea class="form-control" id="ext_config" name="ext_config" rows="10" placeholder="Paste or edit extension config...">{{ policy.ext_config if policy else '' }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary">{{ 'Save Changes' if mode == 'edit' else 'Create Policy' }}</button>
    <a href="{{ url_for('ra_policies_page') }}" class="btn btn-secondary ml-2">Cancel</a>
  </form>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const btn = document.getElementById('load_profile_btn');
      const select = document.getElementById('profile_name');
      const textarea = document.getElementById('ext_config');
      if (!btn || !select || !textarea) return;
      btn.addEventListener('click', function() {
        const name = select.value;
        if (!name) return;
        fetch('/load_profile?filename=' + encodeURIComponent(name))
          .then(r => r.ok ? r.text() : '')
          .then(txt => { if (txt) textarea.value = txt; });
      });
    });
  </script>
{% endblock %}
